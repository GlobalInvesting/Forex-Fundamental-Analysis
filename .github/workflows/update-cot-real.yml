name: Update COT Data (Investing.com Scraping)
on:
  schedule:
    - cron: '0 20 * * 5'  # Fridays at 8:00 PM UTC (after CFTC 3:30 PM ET release)
  workflow_dispatch:

jobs:
  update-cot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 lxml --break-system-packages
      
      - name: Create cot-data directory
        run: mkdir -p cot-data
      
      - name: Fetch COT data from Investing.com
        run: |
          cat > fetch_cot_investing.py << 'EOFPYTHON'
          import requests
          from bs4 import BeautifulSoup
          import json
          import re
          from datetime import date
          import time
          
          HEADERS = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
              'Accept-Language': 'en-US,en;q=0.9',
              'Accept-Encoding': 'gzip, deflate, br',
              'DNT': '1',
              'Connection': 'keep-alive',
              'Upgrade-Insecure-Requests': '1'
          }
          
          # Investing.com URLs for each currency
          COT_URLS = {
              'EUR': 'https://www.investing.com/economic-calendar/cftc-eur-speculative-positions-1611',
              'GBP': 'https://www.investing.com/economic-calendar/cftc-gbp-speculative-positions-1612',
              'JPY': 'https://www.investing.com/economic-calendar/cftc-jpy-speculative-positions-1614',
              'AUD': 'https://www.investing.com/economic-calendar/cftc-aud-speculative-positions-1615',
              'CAD': 'https://www.investing.com/economic-calendar/cftc-cad-speculative-positions-1613',
              'CHF': 'https://www.investing.com/economic-calendar/cftc-chf-speculative-positions-1617',
              'NZD': 'https://www.investing.com/economic-calendar/cftc-nzd-speculative-positions-1616'
          }
          
          def clean_number(text):
              """Extract numeric value from text like '+45.2K' or '-12.3K'"""
              if not text:
                  return None
              
              # Remove whitespace and convert to uppercase
              text = text.strip().upper()
              
              # Look for pattern like +45.2K or -12.3K
              match = re.search(r'([+-]?\d+\.?\d*)\s*K', text)
              
              if match:
                  value = float(match.group(1))
                  # Convert K to thousands
                  return int(value * 1000)
              
              # Try without K suffix
              match = re.search(r'([+-]?\d+\.?\d*)', text)
              if match:
                  return int(float(match.group(1)))
              
              return None
          
          def fetch_cot_from_investing(currency, url):
              """
              Scrape COT positioning from Investing.com
              """
              print(f"\n{'='*80}")
              print(f"FETCHING {currency} from Investing.com")
              print(f"{'='*80}")
              
              try:
                  response = requests.get(url, headers=HEADERS, timeout=20)
                  
                  if not response.ok:
                      print(f"  âŒ HTTP {response.status_code}")
                      return None
                  
                  soup = BeautifulSoup(response.content, 'lxml')
                  
                  # Method 1: Look for table with "Actual" column
                  tables = soup.find_all('table')
                  
                  for table in tables:
                      rows = table.find_all('tr')
                      
                      for row in rows:
                          cells = row.find_all(['td', 'th'])
                          
                          # Look for header row with "Actual"
                          headers = [cell.get_text(strip=True).lower() for cell in cells]
                          
                          if 'actual' in headers:
                              actual_index = headers.index('actual')
                              
                              # Next row should have the value
                              next_row = row.find_next_sibling('tr')
                              if next_row:
                                  next_cells = next_row.find_all('td')
                                  
                                  if len(next_cells) > actual_index:
                                      actual_value = next_cells[actual_index].get_text(strip=True)
                                      
                                      net_position = clean_number(actual_value)
                                      
                                      if net_position is not None:
                                          print(f"  âœ… Found in table: {net_position:+,} contracts")
                                          return net_position
                  
                  # Method 2: Look for specific div/span patterns
                  # Investing.com often uses data attributes
                  actual_elements = soup.find_all(attrs={'data-test': re.compile('actual', re.I)})
                  
                  for elem in actual_elements:
                      text = elem.get_text(strip=True)
                      net_position = clean_number(text)
                      
                      if net_position is not None:
                          print(f"  âœ… Found in data-test: {net_position:+,} contracts")
                          return net_position
                  
                  # Method 3: Search for K pattern in entire page
                  text = soup.get_text()
                  
                  # Look for patterns like "Actual: +45.2K" or just "+45.2K"
                  patterns = [
                      r'actual[:\s]+([+-]?\d+\.?\d*)\s*K',
                      r'([+-]\d+\.?\d*)\s*K'
                  ]
                  
                  for pattern in patterns:
                      matches = re.findall(pattern, text, re.IGNORECASE)
                      
                      if matches:
                          # Take the first reasonable match
                          for match in matches:
                              value = float(match.replace('+', '').replace('-', '-'))
                              net_position = int(value * 1000)
                              
                              # Sanity check: COT values typically between -200K and +200K
                              if -200000 <= net_position <= 200000:
                                  print(f"  âœ… Found in text: {net_position:+,} contracts")
                                  return net_position
                  
                  print(f"  âš ï¸  Could not extract COT value from page")
                  
                  # Debug: print first 500 chars
                  print(f"\n  Debug - First 500 chars of page:")
                  print(f"  {text[:500]}")
                  
                  return None
                  
              except Exception as e:
                  print(f"  âŒ Error: {e}")
                  return None
          
          # ============================================
          # MAIN EXECUTION
          # ============================================
          
          print("\n" + "="*80)
          print("COT DATA FETCHER - Investing.com Scraping")
          print("="*80)
          
          cot_data = {}
          
          for currency, url in COT_URLS.items():
              net_position = fetch_cot_from_investing(currency, url)
              
              if net_position is not None:
                  cot_data[currency] = {
                      'netPosition': net_position,
                      'source': 'Investing.com',
                      'reportDate': str(date.today())
                  }
              
              time.sleep(2)  # Be polite to Investing.com servers
          
          # ========== SAVE RESULTS ==========
          print("\n" + "="*80)
          print("SAVING COT DATA")
          print("="*80)
          
          if not cot_data:
              print("\nâŒ CRITICAL ERROR: NO COT DATA OBTAINED")
              print("   Manual intervention required")
              print("\nâš ï¸  COT data will NOT be available in dashboard")
              exit(0)  # Don't fail workflow, just skip COT
          
          for currency, data in cot_data.items():
              filename = f'cot-data/{currency}.json'
              
              with open(filename, 'w') as f:
                  json.dump(data, f, indent=2)
              
              print(f"ğŸ’¾ {currency}: {data['netPosition']:+,} contracts")
          
          # ========== VALIDATION ==========
          print("\n" + "="*80)
          print("VALIDATION")
          print("="*80)
          
          missing = [c for c in COT_URLS.keys() if c not in cot_data]
          
          if missing:
              print(f"\nâš ï¸  Missing COT data for: {', '.join(missing)}")
              print("   These currencies will show 'N/A' in dashboard")
          else:
              print("\nâœ… COMPLETE: All 7 currencies have COT data")
          
          print("\n" + "="*80)
          print("COT POSITIONING SUMMARY")
          print("="*80)
          
          sorted_currencies = sorted(
              cot_data.keys(),
              key=lambda c: cot_data[c]['netPosition'],
              reverse=True
          )
          
          for currency in sorted_currencies:
              data = cot_data[currency]
              net = data['netPosition']
              
              if net > 50000:
                  sentiment = "ğŸŸ¢ Strong Bullish"
              elif net > 20000:
                  sentiment = "ğŸŸ¡ Bullish"
              elif net > -20000:
                  sentiment = "âšª Neutral"
              elif net > -50000:
                  sentiment = "ğŸŸ  Bearish"
              else:
                  sentiment = "ğŸ”´ Strong Bearish"
              
              print(f"{currency}: {net:+10,} contracts  {sentiment}")
          
          print("\nâœ… COT UPDATE COMPLETED")
          
          EOFPYTHON
          
          python fetch_cot_investing.py
      
      - name: Display COT summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         COT POSITIONING SUMMARY                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          for currency in EUR GBP JPY AUD CAD CHF NZD; do
            if [ -f "cot-data/$currency.json" ]; then
              echo "[$currency]"
              python3 -c "
          import json
          with open('cot-data/$currency.json') as f:
              data = json.load(f)
              print(f\"  Net Position: {data['netPosition']:+,} contracts\")
              print(f\"  Source: {data['source']}\")
              print(f\"  Report Date: {data['reportDate']}\")
          "
              echo ""
            else
              echo "[$currency] - No data available"
              echo ""
            fi
          done
      
      - name: Commit and push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add cot-data/
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ“Š COT update $(date +'%Y-%m-%d') - Investing.com scraping"
            git pull --rebase origin main || true
            git push
          fi
