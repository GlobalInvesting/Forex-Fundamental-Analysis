name: Update Interest Rates
on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  update-rates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Create rates directory
        run: mkdir -p rates
      
      # USD - Federal Funds Rate
      - name: Fetch USD rate
        run: |
          curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=FEDFUNDS&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" > rates/USD.json
          if ! jq -e '.observations[0].value' rates/USD.json > /dev/null 2>&1; then
            echo '{"observations":[{"value":"4.50","date":"2026-02-12"}]}' > rates/USD.json
          fi
      
      # EUR - ECB Main Refinancing Rate
      - name: Fetch EUR rate
        run: |
          curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=ECBMRRFR&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" > rates/EUR.json
          if ! jq -e '.observations[0].value' rates/EUR.json > /dev/null 2>&1; then
            echo '{"observations":[{"value":"2.15","date":"2026-02-12"}]}' > rates/EUR.json
          fi
      
      # GBP - FALLBACK to current rate (FRED series outdated)
      - name: Fetch GBP rate
        run: |
          # Try FRED first
          curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IUDSOIA&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" > rates/GBP.json
          
          # Check if date is older than 2024
          DATE=$(jq -r '.observations[0].date // "2000-01-01"' rates/GBP.json)
          YEAR=$(echo $DATE | cut -d'-' -f1)
          
          if [ "$YEAR" -lt 2024 ]; then
            echo "GBP data too old ($DATE), using fallback"
            echo '{"observations":[{"value":"4.75","date":"2026-02-12"}]}' > rates/GBP.json
          fi
      
      # JPY - FALLBACK (FRED series outdated)
      - name: Fetch JPY rate
        run: |
          curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=BOJPOLTGT&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" > rates/JPY.json
          
          DATE=$(jq -r '.observations[0].date // "2000-01-01"' rates/JPY.json)
          YEAR=$(echo $DATE | cut -d'-' -f1)
          
          if [ "$YEAR" -lt 2024 ]; then
            echo "JPY data too old ($DATE), using fallback"
            echo '{"observations":[{"value":"0.50","date":"2026-02-12"}]}' > rates/JPY.json
          fi
      
      # AUD - FALLBACK
      - name: Fetch AUD rate
        run: |
          curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=RBATCTR&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" > rates/AUD.json
          
          if ! jq -e '.observations[0].value' rates/AUD.json > /dev/null 2>&1; then
            echo "AUD data missing, using fallback"
            echo '{"observations":[{"value":"4.35","date":"2026-02-12"}]}' > rates/AUD.json
          fi
      
      # CAD - FALLBACK (series outdated)
      - name: Fetch CAD rate
        run: |
          curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IRSTCB01CAM156N&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" > rates/CAD.json
          
          DATE=$(jq -r '.observations[0].date // "2000-01-01"' rates/CAD.json)
          YEAR=$(echo $DATE | cut -d'-' -f1)
          
          if [ "$YEAR" -lt 2024 ]; then
            echo "CAD data too old ($DATE), using fallback"
            echo '{"observations":[{"value":"3.25","date":"2026-02-12"}]}' > rates/CAD.json
          fi
      
      # CHF - FALLBACK
      - name: Fetch CHF rate
        run: |
          curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=SNBLR3M&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" > rates/CHF.json
          
          if ! jq -e '.observations[0].value' rates/CHF.json > /dev/null 2>&1; then
            echo "CHF data missing, using fallback"
            echo '{"observations":[{"value":"0.50","date":"2026-02-12"}]}' > rates/CHF.json
          fi
      
      # NZD - FALLBACK
      - name: Fetch NZD rate
        run: |
          curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=NZOCRS&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" > rates/NZD.json
          
          if ! jq -e '.observations[0].value' rates/NZD.json > /dev/null 2>&1; then
            echo "NZD data missing, using fallback"
            echo '{"observations":[{"value":"4.25","date":"2026-02-12"}]}' > rates/NZD.json
          fi
      
      - name: Display final rates
        run: |
          echo "=== FINAL RATES ==="
          for currency in USD EUR GBP JPY AUD CAD CHF NZD; do
            echo "=== $currency ==="
            jq -r '.observations[0] | "Value: \(.value)% | Date: \(.date)"' rates/$currency.json
          done
      
      - name: Commit and push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add rates/
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update rates $(date +'%Y-%m-%d %H:%M UTC')" && git push)
