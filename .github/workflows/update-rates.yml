name: Update Interest Rates (100% Autonomous + 100% Reliable) - FIXED
on:
  schedule:
    - cron: '0 8 * * *'  # Daily at 8:00 AM UTC
  workflow_dispatch:

jobs:
  update-rates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Create rates directory
        run: mkdir -p rates
      
      # ========================================
      # USD - Federal Reserve (HIGHLY RELIABLE)
      # ========================================
      - name: Fetch USD rate
        run: |
          echo "ğŸ‡ºğŸ‡¸ Fetching USD rate..."
          RATE=""
          SOURCE=""
          
          # Source 1: FRED DFF (Federal Funds Rate - Most reliable)
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=DFF&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" 2>/dev/null | jq -r '.observations[0].value // empty' 2>/dev/null)
          [ -n "$RATE" ] && [ "$RATE" != "null" ] && [ "$RATE" != "." ] && SOURCE="FRED-DFF"
          
          # Source 2: Alpha Vantage Federal Funds Rate
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            RATE=$(curl -s "https://www.alphavantage.co/query?function=FEDERAL_FUNDS_RATE&apikey=demo" 2>/dev/null | jq -r '.data[0].value // empty' 2>/dev/null)
            [ -n "$RATE" ] && [ "$RATE" != "null" ] && SOURCE="AlphaVantage"
          fi
          
          # Fallback: Last known value
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            if [ -f "rates/USD.json" ]; then
              RATE=$(jq -r '.observations[0].value' rates/USD.json 2>/dev/null)
              SOURCE="LastKnown"
              echo "âš ï¸ USD: Using last known value: $RATE%"
            fi
          fi
          
          if [ -n "$RATE" ] && [ "$RATE" != "null" ] && [ "$RATE" != "." ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\",\"source\":\"$SOURCE\"}]}" > rates/USD.json
            echo "âœ“ USD: $RATE% ($SOURCE)"
          else
            echo "âŒ USD: All sources failed"
            exit 1
          fi
      
      # ========================================
      # EUR - European Central Bank (IMPROVED)
      # ========================================
      - name: Fetch EUR rate
        run: |
          echo "ğŸ‡ªğŸ‡º Fetching EUR rate..."
          RATE=""
          SOURCE=""
          
          # Source 1: ECB Statistical Data Warehouse (OFFICIAL - Deposit Facility Rate)
          RATE=$(curl -s "https://sdw-wsrest.ecb.europa.eu/service/data/FM/D.U2.EUR.4F.KR.DFR.LEV?lastNObservations=1&format=jsondata" 2>/dev/null | jq -r '.dataSets[0].series."0:0:0:0:0:0:0".observations."0"[0] // empty' 2>/dev/null)
          [ -n "$RATE" ] && [ "$RATE" != "null" ] && SOURCE="ECB-SDW-Deposit"
          
          # Source 2: FRED Deposit Rate
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=ECBDFR&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" 2>/dev/null | jq -r '.observations[0].value // empty' 2>/dev/null)
            [ -n "$RATE" ] && [ "$RATE" != "null" ] && [ "$RATE" != "." ] && SOURCE="FRED-Deposit"
          fi
          
          # Source 3: FRED Main Refinancing Rate
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=ECBMRRFR&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" 2>/dev/null | jq -r '.observations[0].value // empty' 2>/dev/null)
            [ -n "$RATE" ] && [ "$RATE" != "null" ] && [ "$RATE" != "." ] && SOURCE="FRED-Refinancing"
          fi
          
          # Source 4: OECD Short-term Interest Rate
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            RATE=$(curl -s "https://stats.oecd.org/sdmx-json/data/DP_LIVE/.IR.../OECD?contentType=json&startTime=2025" 2>/dev/null | jq -r '.dataSets[0].series | to_entries[] | select(.key | contains("EA19")) | .value.observations | to_entries | sort_by(.key) | .[-1].value[0] // empty' 2>/dev/null)
            [ -n "$RATE" ] && [ "$RATE" != "null" ] && SOURCE="OECD"
          fi
          
          # Fallback: Last known value
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            if [ -f "rates/EUR.json" ]; then
              RATE=$(jq -r '.observations[0].value' rates/EUR.json 2>/dev/null)
              SOURCE="LastKnown"
              echo "âš ï¸ EUR: Using last known value: $RATE%"
            fi
          fi
          
          if [ -n "$RATE" ] && [ "$RATE" != "null" ] && [ "$RATE" != "." ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\",\"source\":\"$SOURCE\"}]}" > rates/EUR.json
            echo "âœ“ EUR: $RATE% ($SOURCE)"
          else
            echo "âŒ EUR: All sources failed"
            exit 1
          fi
      
      # ========================================
      # GBP - Bank of England (RELIABLE)
      # ========================================
      - name: Fetch GBP rate
        run: |
          echo "ğŸ‡¬ğŸ‡§ Fetching GBP rate..."
          RATE=""
          SOURCE=""
          
          # Source 1: FRED Bank Rate
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IUDSOIA&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" 2>/dev/null | jq -r '.observations[0].value // empty' 2>/dev/null)
          [ -n "$RATE" ] && [ "$RATE" != "null" ] && [ "$RATE" != "." ] && SOURCE="FRED"
          
          # Source 2: OECD UK Interest Rate
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            RATE=$(curl -s "https://stats.oecd.org/sdmx-json/data/DP_LIVE/.IR.../OECD?contentType=json&startTime=2025" 2>/dev/null | jq -r '.dataSets[0].series | to_entries[] | select(.key | contains("GBR")) | .value.observations | to_entries | sort_by(.key) | .[-1].value[0] // empty' 2>/dev/null)
            [ -n "$RATE" ] && [ "$RATE" != "null" ] && SOURCE="OECD"
          fi
          
          # Fallback: Last known value
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            if [ -f "rates/GBP.json" ]; then
              RATE=$(jq -r '.observations[0].value' rates/GBP.json 2>/dev/null)
              SOURCE="LastKnown"
              echo "âš ï¸ GBP: Using last known value: $RATE%"
            fi
          fi
          
          if [ -n "$RATE" ] && [ "$RATE" != "null" ] && [ "$RATE" != "." ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\",\"source\":\"$SOURCE\"}]}" > rates/GBP.json
            echo "âœ“ GBP: $RATE% ($SOURCE)"
          else
            echo "âŒ GBP: All sources failed"
            exit 1
          fi
      
      # ========================================
      # JPY - Bank of Japan (FIXED WITH MULTIPLE SOURCES)
      # ========================================
      - name: Fetch JPY rate
        run: |
          echo "ğŸ‡¯ğŸ‡µ Fetching JPY rate..."
          RATE=""
          SOURCE=""
          
          # Source 1: FRED Japan Policy Rate (Most updated)
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IRSTCI01JPM156N&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=10&sort_order=desc" 2>/dev/null | jq -r '.observations[] | select(.value != ".") | .value' 2>/dev/null | head -1)
          [ -n "$RATE" ] && [ "$RATE" != "null" ] && [ "$RATE" != "." ] && SOURCE="FRED"
          
          # Source 2: BIS (Bank for International Settlements)
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            RATE=$(curl -s "https://data.bis.org/api/v2/data/dataflow/BIS/WS_CBPOL/1.0/M.JP?format=jsondata&lastNObservations=1" 2>/dev/null | jq -r '.data.dataSets[0].series."0:0".observations."0"[0] // empty' 2>/dev/null)
            [ -n "$RATE" ] && [ "$RATE" != "null" ] && SOURCE="BIS"
          fi
          
          # Source 3: OECD Japan Interest Rate
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            RATE=$(curl -s "https://stats.oecd.org/sdmx-json/data/DP_LIVE/.IR.../OECD?contentType=json&startTime=2025" 2>/dev/null | jq -r '.dataSets[0].series | to_entries[] | select(.key | contains("JPN")) | .value.observations | to_entries | sort_by(.key) | .[-1].value[0] // empty' 2>/dev/null)
            [ -n "$RATE" ] && [ "$RATE" != "null" ] && SOURCE="OECD"
          fi
          
          # Fallback: Last known value
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            if [ -f "rates/JPY.json" ]; then
              RATE=$(jq -r '.observations[0].value' rates/JPY.json 2>/dev/null)
              SOURCE="LastKnown"
              echo "âš ï¸ JPY: Using last known value: $RATE%"
            fi
          fi
          
          if [ -n "$RATE" ] && [ "$RATE" != "null" ] && [ "$RATE" != "." ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\",\"source\":\"$SOURCE\"}]}" > rates/JPY.json
            echo "âœ“ JPY: $RATE% ($SOURCE)"
          else
            echo "âŒ JPY: All sources failed"
            exit 1
          fi
      
      # ========================================
      # CAD - Bank of Canada (ALREADY PERFECT)
      # ========================================
      - name: Fetch CAD rate
        run: |
          echo "ğŸ‡¨ğŸ‡¦ Fetching CAD rate..."
          RATE=""
          SOURCE=""
          
          # Source 1: Bank of Canada Official API (BEST SOURCE)
          RATE=$(curl -s "https://www.bankofcanada.ca/valet/observations/V39079/json?recent=1" 2>/dev/null | jq -r '.observations[0].V39079.v // empty' 2>/dev/null)
          [ -n "$RATE" ] && [ "$RATE" != "null" ] && SOURCE="BankOfCanada-API"
          
          # Source 2: FRED Canada
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IRSTCI01CAM156N&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=10&sort_order=desc" 2>/dev/null | jq -r '.observations[] | select(.value != ".") | .value' 2>/dev/null | head -1)
            [ -n "$RATE" ] && [ "$RATE" != "null" ] && [ "$RATE" != "." ] && SOURCE="FRED"
          fi
          
          # Source 3: OECD Canada
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            RATE=$(curl -s "https://stats.oecd.org/sdmx-json/data/DP_LIVE/.IR.../OECD?contentType=json&startTime=2025" 2>/dev/null | jq -r '.dataSets[0].series | to_entries[] | select(.key | contains("CAN")) | .value.observations | to_entries | sort_by(.key) | .[-1].value[0] // empty' 2>/dev/null)
            [ -n "$RATE" ] && [ "$RATE" != "null" ] && SOURCE="OECD"
          fi
          
          # Fallback: Last known value
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            if [ -f "rates/CAD.json" ]; then
              RATE=$(jq -r '.observations[0].value' rates/CAD.json 2>/dev/null)
              SOURCE="LastKnown"
              echo "âš ï¸ CAD: Using last known value: $RATE%"
            fi
          fi
          
          if [ -n "$RATE" ] && [ "$RATE" != "null" ] && [ "$RATE" != "." ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\",\"source\":\"$SOURCE\"}]}" > rates/CAD.json
            echo "âœ“ CAD: $RATE% ($SOURCE)"
          else
            echo "âŒ CAD: All sources failed"
            exit 1
          fi
      
      # ========================================
      # AUD - Reserve Bank of Australia (FIXED)
      # ========================================
      - name: Fetch AUD rate
        run: |
          echo "ğŸ‡¦ğŸ‡º Fetching AUD rate..."
          RATE=""
          SOURCE=""
          
          # Source 1: FRED Australia (Most reliable for AUD)
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IRSTCI01AUM156N&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=10&sort_order=desc" 2>/dev/null | jq -r '.observations[] | select(.value != ".") | .value' 2>/dev/null | head -1)
          [ -n "$RATE" ] && [ "$RATE" != "null" ] && [ "$RATE" != "." ] && SOURCE="FRED"
          
          # Source 2: BIS Australia
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            RATE=$(curl -s "https://data.bis.org/api/v2/data/dataflow/BIS/WS_CBPOL/1.0/M.AU?format=jsondata&lastNObservations=1" 2>/dev/null | jq -r '.data.dataSets[0].series."0:0".observations."0"[0] // empty' 2>/dev/null)
            [ -n "$RATE" ] && [ "$RATE" != "null" ] && SOURCE="BIS"
          fi
          
          # Source 3: OECD Australia
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            RATE=$(curl -s "https://stats.oecd.org/sdmx-json/data/DP_LIVE/.IR.../OECD?contentType=json&startTime=2025" 2>/dev/null | jq -r '.dataSets[0].series | to_entries[] | select(.key | contains("AUS")) | .value.observations | to_entries | sort_by(.key) | .[-1].value[0] // empty' 2>/dev/null)
            [ -n "$RATE" ] && [ "$RATE" != "null" ] && SOURCE="OECD"
          fi
          
          # Fallback: Last known value
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            if [ -f "rates/AUD.json" ]; then
              RATE=$(jq -r '.observations[0].value' rates/AUD.json 2>/dev/null)
              SOURCE="LastKnown"
              echo "âš ï¸ AUD: Using last known value: $RATE%"
            fi
          fi
          
          if [ -n "$RATE" ] && [ "$RATE" != "null" ] && [ "$RATE" != "." ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\",\"source\":\"$SOURCE\"}]}" > rates/AUD.json
            echo "âœ“ AUD: $RATE% ($SOURCE)"
          else
            echo "âŒ AUD: All sources failed"
            exit 1
          fi
      
      # ========================================
      # CHF - Swiss National Bank (CRITICAL FIX)
      # ========================================
      - name: Fetch CHF rate
        run: |
          echo "ğŸ‡¨ğŸ‡­ Fetching CHF rate..."
          RATE=""
          SOURCE=""
          
          # Source 1: FRED Switzerland (Primary - most reliable)
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IRSTCI01CHM156N&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=10&sort_order=desc" 2>/dev/null | jq -r '.observations[] | select(.value != ".") | .value' 2>/dev/null | head -1)
          [ -n "$RATE" ] && [ "$RATE" != "null" ] && [ "$RATE" != "." ] && SOURCE="FRED"
          
          # Source 2: OECD Switzerland
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            RATE=$(curl -s "https://stats.oecd.org/sdmx-json/data/DP_LIVE/.IR.../OECD?contentType=json&startTime=2025" 2>/dev/null | jq -r '.dataSets[0].series | to_entries[] | select(.key | contains("CHE")) | .value.observations | to_entries | sort_by(.key) | .[-1].value[0] // empty' 2>/dev/null)
            [ -n "$RATE" ] && [ "$RATE" != "null" ] && SOURCE="OECD"
          fi
          
          # Source 3: BIS Switzerland
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            RATE=$(curl -s "https://data.bis.org/api/v2/data/dataflow/BIS/WS_CBPOL/1.0/M.CH?format=jsondata&lastNObservations=1" 2>/dev/null | jq -r '.data.dataSets[0].series."0:0".observations."0"[0] // empty' 2>/dev/null)
            [ -n "$RATE" ] && [ "$RATE" != "null" ] && SOURCE="BIS"
          fi
          
          # Source 4: SNB Data Portal (trying alternative endpoint)
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            # Try SNB's public CSV data (backup)
            SNB_DATA=$(curl -s "https://data.snb.ch/api/cube/snbpol/data/csv/en" 2>/dev/null)
            if [ -n "$SNB_DATA" ] && [ "$SNB_DATA" != *"not found"* ]; then
              RATE=$(echo "$SNB_DATA" | tail -1 | cut -d',' -f2 2>/dev/null | tr -d '\r' | xargs)
              [ -n "$RATE" ] && [ "$RATE" != "null" ] && [ "$RATE" != "" ] && SOURCE="SNB-Portal"
            fi
          fi
          
          # Fallback: Last known value
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            if [ -f "rates/CHF.json" ]; then
              RATE=$(jq -r '.observations[0].value' rates/CHF.json 2>/dev/null)
              SOURCE="LastKnown"
              echo "âš ï¸ CHF: Using last known value: $RATE%"
            fi
          fi
          
          if [ -n "$RATE" ] && [ "$RATE" != "null" ] && [ "$RATE" != "." ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\",\"source\":\"$SOURCE\"}]}" > rates/CHF.json
            echo "âœ“ CHF: $RATE% ($SOURCE)"
          else
            echo "âŒ CHF: All sources failed"
            exit 1
          fi
      
      # ========================================
      # NZD - Reserve Bank of New Zealand (CRITICAL FIX)
      # ========================================
      - name: Fetch NZD rate
        run: |
          echo "ğŸ‡³ğŸ‡¿ Fetching NZD rate..."
          RATE=""
          SOURCE=""
          
          # Source 1: FRED New Zealand (Primary)
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IRSTCI01NZM156N&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=10&sort_order=desc" 2>/dev/null | jq -r '.observations[] | select(.value != ".") | .value' 2>/dev/null | head -1)
          [ -n "$RATE" ] && [ "$RATE" != "null" ] && [ "$RATE" != "." ] && SOURCE="FRED"
          
          # Source 2: OECD New Zealand
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            RATE=$(curl -s "https://stats.oecd.org/sdmx-json/data/DP_LIVE/.IR.../OECD?contentType=json&startTime=2025" 2>/dev/null | jq -r '.dataSets[0].series | to_entries[] | select(.key | contains("NZL")) | .value.observations | to_entries | sort_by(.key) | .[-1].value[0] // empty' 2>/dev/null)
            [ -n "$RATE" ] && [ "$RATE" != "null" ] && SOURCE="OECD"
          fi
          
          # Source 3: BIS New Zealand
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            RATE=$(curl -s "https://data.bis.org/api/v2/data/dataflow/BIS/WS_CBPOL/1.0/M.NZ?format=jsondata&lastNObservations=1" 2>/dev/null | jq -r '.data.dataSets[0].series."0:0".observations."0"[0] // empty' 2>/dev/null)
            [ -n "$RATE" ] && [ "$RATE" != "null" ] && SOURCE="BIS"
          fi
          
          # Source 4: Try RBNZ's Monetary Policy Statement (OCR)
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            # Alternative: parse from RBNZ website
            RBNZ_RATE=$(curl -s "https://www.rbnz.govt.nz/monetary-policy/official-cash-rate-decisions" 2>/dev/null | grep -oP 'OCR.{0,50}?(\d+\.?\d*)%' | head -1 | grep -oP '\d+\.?\d*' 2>/dev/null)
            [ -n "$RBNZ_RATE" ] && RATE="$RBNZ_RATE" && SOURCE="RBNZ-Web"
          fi
          
          # Fallback: Last known value
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            if [ -f "rates/NZD.json" ]; then
              RATE=$(jq -r '.observations[0].value' rates/NZD.json 2>/dev/null)
              SOURCE="LastKnown"
              echo "âš ï¸ NZD: Using last known value: $RATE%"
            fi
          fi
          
          if [ -n "$RATE" ] && [ "$RATE" != "null" ] && [ "$RATE" != "." ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\",\"source\":\"$SOURCE\"}]}" > rates/NZD.json
            echo "âœ“ NZD: $RATE% ($SOURCE)"
          else
            echo "âŒ NZD: All sources failed"
            exit 1
          fi
      
      # ========================================
      # VALIDATION & REPORTING
      # ========================================
      - name: Validate and report
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘    VALIDATION REPORT - AUTONOMOUS + RELIABLE   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          FAILED=0
          for currency in USD EUR GBP JPY AUD CAD CHF NZD; do
            if [ -f "rates/$currency.json" ]; then
              RATE=$(jq -r '.observations[0].value' rates/$currency.json 2>/dev/null)
              DATE=$(jq -r '.observations[0].date' rates/$currency.json 2>/dev/null)
              SOURCE=$(jq -r '.observations[0].source // "Unknown"' rates/$currency.json 2>/dev/null)
              
              # Validate rate is a number
              if [[ "$RATE" =~ ^[0-9]+\.?[0-9]*$ ]]; then
                echo "âœ“ $currency = $RATE% | Date: $DATE | Source: $SOURCE"
              else
                echo "âŒ $currency: INVALID RATE VALUE: $RATE"
                FAILED=1
              fi
            else
              echo "âŒ $currency: FILE MISSING"
              FAILED=1
            fi
          done
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘            DATA SOURCE SUMMARY                 â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "FRED (Federal Reserve Economic Data): Primary for most currencies"
          echo "BIS (Bank for International Settlements): Backup source"
          echo "OECD (Organisation for Economic Co-operation): Tertiary fallback"
          echo "ECB (European Central Bank): EUR primary"
          echo "BoC (Bank of Canada): CAD primary"
          echo "SNB (Swiss National Bank): CHF tertiary"
          echo "RBNZ (Reserve Bank of New Zealand): NZD tertiary"
          
          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "âš ï¸  Some currencies failed validation"
            exit 1
          fi
      
      # ========================================
      # DISPLAY FINAL RATES
      # ========================================
      - name: Display final rates
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         FINAL RATES (100% AUTO + RELIABLE)     â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          for currency in USD EUR GBP JPY AUD CAD CHF NZD; do
            if [ -f rates/$currency.json ]; then
              echo ""
              echo "[$currency]"
              jq -r '.observations[0] | "  Rate: \(.value)%\n  Date: \(.date)\n  Source: \(.source)"' rates/$currency.json
            fi
          done
      
      # ========================================
      # COMMIT AND PUSH
      # ========================================
      - name: Commit and push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add rates/
          git diff --quiet && git diff --staged --quiet || (git commit -m "ğŸ”„ Auto-update rates $(date +'%Y-%m-%d %H:%M UTC') - Reliable sources" && git push)
