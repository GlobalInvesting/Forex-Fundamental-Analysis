name: Update Interest Rates
on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  update-rates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Create rates directory
        run: mkdir -p rates
      
      # USD - Federal Reserve (DFF = Daily Federal Funds Rate)
      - name: Fetch USD rate
        run: |
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=DFF&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" | jq -r '.observations[0].value // empty')
          DATE=$(date +%Y-%m-%d)
          
          if [ -n "$RATE" ] && [ "$RATE" != "null" ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$DATE\"}]}" > rates/USD.json
            echo "✓ USD: $RATE%"
          fi
      
      # EUR - ECB Main Refinancing Rate
      - name: Fetch EUR rate
        run: |
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=ECBMRRFR&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" | jq -r '.observations[0].value // empty')
          DATE=$(date +%Y-%m-%d)
          
          if [ -n "$RATE" ] && [ "$RATE" != "null" ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$DATE\"}]}" > rates/EUR.json
            echo "✓ EUR: $RATE%"
          fi
      
      # GBP - Bank of England
      - name: Fetch GBP rate
        run: |
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IUDSOIA&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" | jq -r '.observations[0].value // empty')
          RATE_DATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IUDSOIA&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" | jq -r '.observations[0].date // empty')
          
          if [ -n "$RATE" ] && [ "$RATE" != "null" ]; then
            YEAR=$(echo $RATE_DATE | cut -d'-' -f1)
            if [ "$YEAR" -ge 2025 ]; then
              echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$RATE_DATE\"}]}" > rates/GBP.json
              echo "✓ GBP: $RATE% (from $RATE_DATE)"
            fi
          fi
      
      # JPY - Multiple sources with aggressive fallback
      - name: Fetch JPY rate
        run: |
          # Source 1: FRED recent data
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IRSTFR01JPM156N&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=5&sort_order=desc" | jq -r '.observations[] | select(.value != ".") | .value' | head -1)
          
          # Source 2: Alpha Vantage (if available)
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE=$(curl -s "https://www.alphavantage.co/query?function=FEDERAL_FUNDS_RATE&apikey=demo" 2>/dev/null | jq -r '.data[0].value // empty' || echo "")
          fi
          
          # Source 3: Last resort - manual BoJ rate (updated monthly)
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE="0.5"  # BoJ current policy rate as of Feb 2026
          fi
          
          if [ -n "$RATE" ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/JPY.json
            echo "✓ JPY: $RATE%"
          fi
      
      # AUD - RBA Official Rate
      - name: Fetch AUD rate
        run: |
          # Source 1: FRED with validation
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IRSTCI01AUM156N&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=5&sort_order=desc" | jq -r '.observations[] | select(.value != ".") | .value' | head -1)
          
          # Source 2: Manual current rate
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE="4.35"  # RBA current cash rate target
          fi
          
          if [ -n "$RATE" ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/AUD.json
            echo "✓ AUD: $RATE%"
          fi
      
      # CAD - Bank of Canada Valet API (working!)
      - name: Fetch CAD rate
        run: |
          CAD_RATE=$(curl -s "https://www.bankofcanada.ca/valet/observations/V39079/json?recent=1" | jq -r '.observations[0].V39079.v // empty')
          
          if [ -n "$CAD_RATE" ] && [ "$CAD_RATE" != "null" ]; then
            echo "{\"observations\":[{\"value\":\"$CAD_RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/CAD.json
            echo "✓ CAD: $CAD_RATE% (Bank of Canada API)"
          fi
      
      # CHF - Swiss National Bank
      - name: Fetch CHF rate
        run: |
          # Source 1: FRED
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IRSTCI01CHM156N&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=5&sort_order=desc" | jq -r '.observations[] | select(.value != ".") | .value' | head -1)
          
          # Source 2: Manual current rate
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE="0.5"  # SNB current policy rate
          fi
          
          if [ -n "$RATE" ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/CHF.json
            echo "✓ CHF: $RATE%"
          fi
      
      # NZD - Reserve Bank of New Zealand
      - name: Fetch NZD rate
        run: |
          # Source 1: FRED
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IRSTCI01NZM156N&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=5&sort_order=desc" | jq -r '.observations[] | select(.value != ".") | .value' | head -1)
          
          # Source 2: Manual current rate
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE="4.25"  # RBNZ current OCR
          fi
          
          if [ -n "$RATE" ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/NZD.json
            echo "✓ NZD: $RATE%"
          fi
      
      - name: Display final rates
        run: |
          echo ""
          echo "╔════════════════════════════════════╗"
          echo "║       FINAL INTEREST RATES         ║"
          echo "╚════════════════════════════════════╝"
          for currency in USD EUR GBP JPY AUD CAD CHF NZD; do
            if [ -f rates/$currency.json ]; then
              echo ""
              echo "[$currency]"
              jq -r '.observations[0] | "  Rate: \(.value)%\n  Date: \(.date)"' rates/$currency.json
            fi
          done
      
      - name: Commit and push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add rates/
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update rates $(date +'%Y-%m-%d %H:%M UTC')" && git push)
