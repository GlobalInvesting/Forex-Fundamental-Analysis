name: Update Interest Rates (100% Autonomous - No Hardcoding)
on:
  schedule:
    - cron: '0 8 * * *'  # Diario a las 8:00 AM UTC
  workflow_dispatch:

jobs:
  update-rates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Create rates directory
        run: mkdir -p rates
      
      # ========================================
      # STRATEGY: Multiple API sources, NO manual fallbacks
      # If all APIs fail, use LAST KNOWN VALUE from existing file
      # ========================================
      
      # USD - Federal Reserve
      - name: Fetch USD rate
        run: |
          echo "ğŸ‡ºğŸ‡¸ Fetching USD rate..."
          RATE=""
          
          # Source 1: FRED DFF
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=DFF&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" 2>/dev/null | jq -r '.observations[0].value // empty' 2>/dev/null)
          
          # Source 2: Alpha Vantage Federal Funds Rate
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            RATE=$(curl -s "https://www.alphavantage.co/query?function=FEDERAL_FUNDS_RATE&apikey=demo" 2>/dev/null | jq -r '.data[0].value // empty' 2>/dev/null)
          fi
          
          # Fallback: Last known value
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            if [ -f "rates/USD.json" ]; then
              RATE=$(jq -r '.observations[0].value' rates/USD.json 2>/dev/null)
              echo "âš ï¸ USD: Using last known value: $RATE%"
            else
              echo "âŒ USD: No data available and no existing file"
              exit 0
            fi
          fi
          
          if [ -n "$RATE" ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/USD.json
            echo "âœ“ USD: $RATE%"
          fi
      
      # EUR - European Central Bank
      - name: Fetch EUR rate
        run: |
          echo "ğŸ‡ªğŸ‡º Fetching EUR rate..."
          RATE=""
          
          # Source 1: FRED Deposit Rate
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=ECBDFR&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" 2>/dev/null | jq -r '.observations[0].value // empty' 2>/dev/null)
          
          # Source 2: FRED Main Refinancing Rate
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=ECBMRRFR&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" 2>/dev/null | jq -r '.observations[0].value // empty' 2>/dev/null)
          fi
          
          # Source 3: FRED Euro Overnight Average
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=ECBESTRVOLWGTTRMDMNRT&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" 2>/dev/null | jq -r '.observations[0].value // empty' 2>/dev/null)
          fi
          
          # Fallback: Last known value
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            if [ -f "rates/EUR.json" ]; then
              RATE=$(jq -r '.observations[0].value' rates/EUR.json 2>/dev/null)
              echo "âš ï¸ EUR: Using last known value: $RATE%"
            else
              echo "âŒ EUR: No data available"
              exit 0
            fi
          fi
          
          if [ -n "$RATE" ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/EUR.json
            echo "âœ“ EUR: $RATE%"
          fi
      
      # GBP - Bank of England
      - name: Fetch GBP rate
        run: |
          echo "ğŸ‡¬ğŸ‡§ Fetching GBP rate..."
          RATE=""
          
          # Source 1: FRED Bank Rate
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IUDSOIA&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=1&sort_order=desc" 2>/dev/null | jq -r '.observations[0].value // empty' 2>/dev/null)
          
          # Fallback: Last known value
          if [ -z "$RATE" ] || [ "$RATE" == "null" ] || [ "$RATE" == "." ]; then
            if [ -f "rates/GBP.json" ]; then
              RATE=$(jq -r '.observations[0].value' rates/GBP.json 2>/dev/null)
              echo "âš ï¸ GBP: Using last known value: $RATE%"
            else
              echo "âŒ GBP: No data available"
              exit 0
            fi
          fi
          
          if [ -n "$RATE" ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/GBP.json
            echo "âœ“ GBP: $RATE%"
          fi
      
      # JPY - Bank of Japan
      - name: Fetch JPY rate
        run: |
          echo "ğŸ‡¯ğŸ‡µ Fetching JPY rate..."
          RATE=""
          
          # Source 1: FRED Japan Policy Rate
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IRSTCI01JPM156N&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=10&sort_order=desc" 2>/dev/null | jq -r '.observations[] | select(.value != ".") | .value' 2>/dev/null | head -1)
          
          # Source 2: FRED Japan Discount Rate
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=INTDSRJPM193N&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=10&sort_order=desc" 2>/dev/null | jq -r '.observations[] | select(.value != ".") | .value' 2>/dev/null | head -1)
          fi
          
          # Source 3: OECD Data (Japan Short-term Interest Rate)
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE=$(curl -s "https://stats.oecd.org/sdmx-json/data/DP_LIVE/.IR.../OECD?contentType=json&startTime=2025" 2>/dev/null | jq -r '.dataSets[0].series | to_entries[] | select(.key | contains("JPN")) | .value.observations | to_entries | sort_by(.key) | .[-1].value[0]' 2>/dev/null | head -1)
          fi
          
          # Fallback: Last known value
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            if [ -f "rates/JPY.json" ]; then
              RATE=$(jq -r '.observations[0].value' rates/JPY.json 2>/dev/null)
              echo "âš ï¸ JPY: Using last known value: $RATE%"
            else
              echo "âŒ JPY: No data available"
              exit 0
            fi
          fi
          
          if [ -n "$RATE" ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/JPY.json
            echo "âœ“ JPY: $RATE%"
          fi
      
      # CAD - Bank of Canada
      - name: Fetch CAD rate
        run: |
          echo "ğŸ‡¨ğŸ‡¦ Fetching CAD rate..."
          RATE=""
          
          # Source 1: Bank of Canada Official API
          RATE=$(curl -s "https://www.bankofcanada.ca/valet/observations/V39079/json?recent=1" 2>/dev/null | jq -r '.observations[0].V39079.v // empty' 2>/dev/null)
          
          # Source 2: FRED Canada
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IRSTCI01CAM156N&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=10&sort_order=desc" 2>/dev/null | jq -r '.observations[] | select(.value != ".") | .value' 2>/dev/null | head -1)
          fi
          
          # Fallback: Last known value
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            if [ -f "rates/CAD.json" ]; then
              RATE=$(jq -r '.observations[0].value' rates/CAD.json 2>/dev/null)
              echo "âš ï¸ CAD: Using last known value: $RATE%"
            else
              echo "âŒ CAD: No data available"
              exit 0
            fi
          fi
          
          if [ -n "$RATE" ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/CAD.json
            echo "âœ“ CAD: $RATE%"
          fi
      
      # AUD - Reserve Bank of Australia
      - name: Fetch AUD rate
        run: |
          echo "ğŸ‡¦ğŸ‡º Fetching AUD rate..."
          RATE=""
          
          # Source 1: FRED Australia
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IRSTCI01AUM156N&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=10&sort_order=desc" 2>/dev/null | jq -r '.observations[] | select(.value != ".") | .value' 2>/dev/null | head -1)
          
          # Source 2: OECD Australia
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE=$(curl -s "https://stats.oecd.org/sdmx-json/data/DP_LIVE/.IR.../OECD?contentType=json&startTime=2025" 2>/dev/null | jq -r '.dataSets[0].series | to_entries[] | select(.key | contains("AUS")) | .value.observations | to_entries | sort_by(.key) | .[-1].value[0]' 2>/dev/null | head -1)
          fi
          
          # Source 3: Alpha Vantage (if available)
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE=$(curl -s "https://www.alphavantage.co/query?function=TREASURY_YIELD&interval=monthly&maturity=3month&apikey=demo" 2>/dev/null | jq -r '.data[0].value // empty' 2>/dev/null)
          fi
          
          # Fallback: Last known value
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            if [ -f "rates/AUD.json" ]; then
              RATE=$(jq -r '.observations[0].value' rates/AUD.json 2>/dev/null)
              echo "âš ï¸ AUD: Using last known value: $RATE%"
            else
              echo "âŒ AUD: No data available"
              exit 0
            fi
          fi
          
          if [ -n "$RATE" ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/AUD.json
            echo "âœ“ AUD: $RATE%"
          fi
      
      # CHF - Swiss National Bank
      - name: Fetch CHF rate
        run: |
          echo "ğŸ‡¨ğŸ‡­ Fetching CHF rate..."
          RATE=""
          
          # Source 1: FRED Switzerland
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IRSTCI01CHM156N&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=10&sort_order=desc" 2>/dev/null | jq -r '.observations[] | select(.value != ".") | .value' 2>/dev/null | head -1)
          
          # Source 2: OECD Switzerland
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE=$(curl -s "https://stats.oecd.org/sdmx-json/data/DP_LIVE/.IR.../OECD?contentType=json&startTime=2025" 2>/dev/null | jq -r '.dataSets[0].series | to_entries[] | select(.key | contains("CHE")) | .value.observations | to_entries | sort_by(.key) | .[-1].value[0]' 2>/dev/null | head -1)
          fi
          
          # Fallback: Last known value
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            if [ -f "rates/CHF.json" ]; then
              RATE=$(jq -r '.observations[0].value' rates/CHF.json 2>/dev/null)
              echo "âš ï¸ CHF: Using last known value: $RATE%"
            else
              echo "âŒ CHF: No data available"
              exit 0
            fi
          fi
          
          if [ -n "$RATE" ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/CHF.json
            echo "âœ“ CHF: $RATE%"
          fi
      
      # NZD - Reserve Bank of New Zealand
      - name: Fetch NZD rate
        run: |
          echo "ğŸ‡³ğŸ‡¿ Fetching NZD rate..."
          RATE=""
          
          # Source 1: FRED New Zealand
          RATE=$(curl -s "https://api.stlouisfed.org/fred/series/observations?series_id=IRSTCI01NZM156N&api_key=5e0ae2ba29361b8ddb614fd5f92c0a51&file_type=json&limit=10&sort_order=desc" 2>/dev/null | jq -r '.observations[] | select(.value != ".") | .value' 2>/dev/null | head -1)
          
          # Source 2: OECD New Zealand
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            RATE=$(curl -s "https://stats.oecd.org/sdmx-json/data/DP_LIVE/.IR.../OECD?contentType=json&startTime=2025" 2>/dev/null | jq -r '.dataSets[0].series | to_entries[] | select(.key | contains("NZL")) | .value.observations | to_entries | sort_by(.key) | .[-1].value[0]' 2>/dev/null | head -1)
          fi
          
          # Fallback: Last known value
          if [ -z "$RATE" ] || [ "$RATE" == "null" ]; then
            if [ -f "rates/NZD.json" ]; then
              RATE=$(jq -r '.observations[0].value' rates/NZD.json 2>/dev/null)
              echo "âš ï¸ NZD: Using last known value: $RATE%"
            else
              echo "âŒ NZD: No data available"
              exit 0
            fi
          fi
          
          if [ -n "$RATE" ]; then
            echo "{\"observations\":[{\"value\":\"$RATE\",\"date\":\"$(date +%Y-%m-%d)\"}]}" > rates/NZD.json
            echo "âœ“ NZD: $RATE%"
          fi
      
      # ========================================
      # VALIDATION
      # ========================================
      - name: Validate all rate files
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘       VALIDATION REPORT            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          for currency in USD EUR GBP JPY AUD CAD CHF NZD; do
            if [ -f "rates/$currency.json" ]; then
              RATE=$(jq -r '.observations[0].value' rates/$currency.json 2>/dev/null)
              DATE=$(jq -r '.observations[0].date' rates/$currency.json 2>/dev/null)
              echo "âœ“ $currency = $RATE% (Date: $DATE)"
            else
              echo "âŒ $currency: FILE MISSING"
            fi
          done
      
      # ========================================
      # DISPLAY FINAL RATES
      # ========================================
      - name: Display final rates
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  FINAL RATES (100% AUTONOMOUS)     â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          for currency in USD EUR GBP JPY AUD CAD CHF NZD; do
            if [ -f rates/$currency.json ]; then
              echo ""
              echo "[$currency]"
              jq -r '.observations[0] | "  Rate: \(.value)%\n  Date: \(.date)"' rates/$currency.json
            fi
          done
      
      # ========================================
      # COMMIT AND PUSH
      # ========================================
      - name: Commit and push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add rates/
          git diff --quiet && git diff --staged --quiet || (git commit -m "ğŸ”„ Auto-update rates $(date +'%Y-%m-%d %H:%M UTC')" && git push)
