name: Update Economic Data - Smart Scale Detection
on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  update-economic-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 lxml --break-system-packages
      
      - name: Create data directory
        run: mkdir -p economic-data
      
      - name: Scrape with smart scale detection
        run: |
          cat > scrape_economics.py << 'EOFPYTHON'
          import requests
          from bs4 import BeautifulSoup
          import json
          import re
          from datetime import date
          import time
          
          HEADERS = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
              'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
              'Accept-Language': 'en-US,en;q=0.9',
          }
          
          CURRENCIES = ['USD', 'EUR', 'GBP', 'JPY', 'CAD', 'AUD', 'CHF', 'NZD']
          
          INDICATOR_URLS = {
              'gdp': 'https://tradingeconomics.com/country-list/gdp?continent=world',
              'gdpGrowth': 'https://tradingeconomics.com/country-list/gdp-growth-rate?continent=world',
              'inflation': 'https://tradingeconomics.com/country-list/inflation-rate?continent=world',
              'unemployment': 'https://tradingeconomics.com/country-list/unemployment-rate?continent=world',
              'debt': 'https://tradingeconomics.com/country-list/government-debt-to-gdp',
              'currentAccount': 'https://tradingeconomics.com/country-list/current-account-to-gdp?continent=world',
              'production': 'https://tradingeconomics.com/country-list/industrial-production?continent=world',
              'tradeBalance': 'https://tradingeconomics.com/country-list/balance-of-trade'
          }
          
          COUNTRY_NAMES = {
              'USD': ['United States', 'USA'],
              'EUR': ['Euro Area', 'Eurozone'],
              'GBP': ['United Kingdom', 'UK'],
              'JPY': ['Japan'],
              'CAD': ['Canada'],
              'AUD': ['Australia'],
              'CHF': ['Switzerland'],
              'NZD': ['New Zealand']
          }
          
          # CRITICAL: Known scale patterns for trade balance
          # Based on Trading Economics display conventions
          TRADE_BALANCE_SCALE_RULES = {
              # Countries that report in BILLIONS (values usually < 500)
              'USD': 'billion',   # USA: -56.83 means -56.83 billion
              'EUR': 'million',   # Eurozone: 9896 means 9896 million
              'JPY': 'billion',   # Japan: 106 means 106 billion (JPY)
              'GBP': 'million',   # UK: -4340 means -4340 million (GBP)
              'CAD': 'million',   # Canada: -2200 means -2200 million
              'AUD': 'million',   # Australia: 3373 means 3373 million
              'CHF': 'million',   # Switzerland: 3036 means 3036 million
              'NZD': 'million',   # New Zealand: 52 means 52 million
          }
          
          exchange_rates = {}
          
          def fetch_exchange_rates():
              global exchange_rates
              
              print("\n" + "="*80)
              print("FETCHING LIVE EXCHANGE RATES")
              print("="*80)
              
              try:
                  apis = [
                      'https://api.frankfurter.app/latest?from=USD',
                      'https://api.exchangerate-api.com/v4/latest/USD',
                      'https://open.er-api.com/v6/latest/USD'
                  ]
                  
                  for api_url in apis:
                      try:
                          response = requests.get(api_url, timeout=10)
                          if response.ok:
                              data = response.json()
                              rates = data.get('rates', {})
                              
                              if rates:
                                  exchange_rates = rates
                                  exchange_rates['USD'] = 1.0
                                  
                                  print("âœ… Live rates:")
                                  for curr in CURRENCIES:
                                      rate = exchange_rates.get(curr, 'N/A')
                                      print(f"   1 USD = {rate} {curr}")
                                  return True
                      except:
                          continue
                  
                  print("âš ï¸  Using fallback rates")
                  exchange_rates = {
                      'USD': 1.0, 'EUR': 0.84, 'GBP': 0.73, 'JPY': 153.71,
                      'CAD': 1.36, 'AUD': 1.40, 'CHF': 0.77, 'NZD': 1.65
                  }
                  return True
                  
              except Exception as e:
                  print(f"âŒ Error: {e}")
                  return False
          
          def infer_trade_balance_currency(currency_code, value):
              """
              Infer source currency for trade balance
              
              Rules:
              - JPY reports in JPY (values are in billions JPY)
              - GBP reports in GBP (values are in millions GBP)
              - CHF reports in CHF (values are in millions CHF)
              - Everyone else reports in USD
              """
              # Countries that report in their own currency
              local_currency_countries = {
                  'JPY': 'JPY',
                  'GBP': 'GBP',
                  'CHF': 'CHF',
                  'AUD': 'AUD',
                  'NZD': 'NZD',
                  'CAD': 'CAD'
              }
              
              return local_currency_countries.get(currency_code, 'USD')
          
          def convert_trade_balance_to_usd_millions(currency_code, value):
              """
              Convert trade balance to USD Millions using smart detection
              
              Process:
              1. Determine if value is in billions or millions (from known patterns)
              2. Determine source currency (from known patterns)
              3. Convert to millions in source currency
              4. Convert to USD using FX rate
              
              Example: Japan 106 JPY Billion
                Step 1: scale_type = 'billion'
                Step 2: source_currency = 'JPY'
                Step 3: 106 * 1000 = 106,000 JPY Millions
                Step 4: 106,000 / 153.71 = 689,612 USD Millions âœ“
              """
              if value is None:
                  return None
              
              # Step 1: Get scale (billion or million)
              scale_type = TRADE_BALANCE_SCALE_RULES.get(currency_code, 'million')
              
              # Step 2: Get source currency
              source_currency = infer_trade_balance_currency(currency_code, value)
              
              # Step 3: Convert to millions in source currency
              if scale_type == 'billion':
                  # CRITICAL FIX: Convert billions to millions FIRST
                  value_in_source_millions = value * 1000.0  # billions to millions
              else:
                  value_in_source_millions = value  # already in millions
              
              # Step 4: Convert to USD
              if source_currency == 'USD':
                  value_usd_millions = value_in_source_millions
              else:
                  fx_rate = exchange_rates.get(source_currency)
                  if fx_rate is None or fx_rate == 0:
                      print(f"      âš ï¸  No FX rate for {source_currency}")
                      return None
                  # Convert from source currency to USD
                  value_usd_millions = value_in_source_millions / fx_rate
              
              return value_usd_millions
          
          def clean_number(text):
              if not text:
                  return None
              text = str(text).strip().replace(',', '').replace('%', '').replace(' ', '')
              match = re.search(r'(-?\d+\.?\d*)', text)
              if match:
                  try:
                      return float(match.group(1))
                  except:
                      pass
              return None
          
          def scrape_trading_economics_table(url, indicator_name):
              print(f"\n{'='*80}")
              print(f"SCRAPING: {indicator_name.upper()}")
              print(f"{'='*80}")
              
              try:
                  response = requests.get(url, headers=HEADERS, timeout=20)
                  response.raise_for_status()
                  soup = BeautifulSoup(response.content, 'lxml')
                  
                  data = {}
                  
                  table = soup.find('table', {'class': 'table'})
                  if not table:
                      print("  âŒ No table found")
                      return data
                  
                  rows = table.find_all('tr')[1:]
                  
                  for row in rows:
                      cols = row.find_all('td')
                      if len(cols) < 2:
                          continue
                      
                      country_text = cols[0].get_text(strip=True)
                      last_value_text = cols[1].get_text(strip=True)
                      
                      for currency_code, country_names in COUNTRY_NAMES.items():
                          if any(name.lower() in country_text.lower() for name in country_names):
                              
                              raw_value = clean_number(last_value_text)
                              
                              if raw_value is None:
                                  print(f"  âš ï¸  {currency_code}: Could not parse '{last_value_text}'")
                                  break
                                  
                              # DEBUG: Show what we read
                              if indicator_name == 'tradeBalance':
                                  print(f"  [DEBUG] {currency_code}: Raw text='{last_value_text}' â†’ Parsed value={raw_value}")
                              
                              # Percentages
                              if indicator_name in ['gdpGrowth', 'inflation', 'unemployment', 
                                                   'debt', 'currentAccount', 'production']:
                                  data[currency_code] = round(raw_value, 2)
                                  print(f"  âœ“ {currency_code}: {raw_value:.2f}%")
                              
                              # GDP (already in Trillions USD)
                              elif indicator_name == 'gdp':
                                  data[currency_code] = round(raw_value, 2)
                                  print(f"  âœ“ {currency_code}: ${raw_value:.2f}T USD")
                              
                              # Trade Balance (smart conversion)
                              elif indicator_name == 'tradeBalance':
                                  scale = TRADE_BALANCE_SCALE_RULES.get(currency_code, 'million')
                                  source_curr = infer_trade_balance_currency(currency_code, raw_value)
                                  
                                  value_usd_millions = convert_trade_balance_to_usd_millions(
                                      currency_code, 
                                      raw_value
                                  )
                                  
                                  if value_usd_millions is not None:
                                      data[currency_code] = round(value_usd_millions, 2)
                                      print(f"  âœ“ {currency_code}: {raw_value:,.2f} {source_curr} {scale} â†’ ${value_usd_millions:,.2f}M USD")
                                  else:
                                      print(f"  âŒ {currency_code}: Conversion failed")
                              
                              break
                  
                  missing = [c for c in CURRENCIES if c not in data]
                  if missing:
                      print(f"  âš ï¸  Missing: {', '.join(missing)}")
                  
                  return data
                  
              except Exception as e:
                  print(f"  âŒ Error: {e}")
                  return {}
          
          def scrape_all_indicators():
              all_data = {}
              for currency in CURRENCIES:
                  all_data[currency] = {}
              
              for indicator_key, url in INDICATOR_URLS.items():
                  indicator_data = scrape_trading_economics_table(url, indicator_key)
                  for currency_code, value in indicator_data.items():
                      all_data[currency_code][indicator_key] = value
                  time.sleep(2)
              
              return all_data
          
          def validate_and_save(all_data):
              print(f"\n{'='*80}")
              print("VALIDATION & SAVING")
              print(f"{'='*80}")
              
              today = str(date.today())
              
              for currency in CURRENCIES:
                  data = all_data.get(currency, {})
                  
                  missing = [ind for ind in INDICATOR_URLS.keys() if data.get(ind) is None]
                  if missing:
                      print(f"âš ï¸  {currency}: Missing {', '.join(missing)}")
                  else:
                      print(f"âœ… {currency}: Complete")
                  
                  data_package = {
                      'lastUpdate': today,
                      'source': 'TradingEconomics',
                      'methodology': 'Smart scale detection based on known country patterns',
                      'units': {
                          'gdp': 'Trillions USD',
                          'tradeBalance': 'Millions USD (monthly, converted from local currency)',
                          'other': 'Percentages'
                      },
                      'data': data
                  }
                  
                  with open(f'economic-data/{currency}.json', 'w') as f:
                      json.dump(data_package, f, indent=2)
          
          def print_summary(all_data):
              print(f"\n{'='*80}")
              print("TRADE BALANCE SUMMARY (USD Millions/month)")
              print(f"{'='*80}")
              
              sorted_currencies = sorted(
                  CURRENCIES,
                  key=lambda c: all_data.get(c, {}).get('tradeBalance', 0),
                  reverse=True
              )
              
              for currency in sorted_currencies:
                  tb = all_data.get(currency, {}).get('tradeBalance')
                  if tb is not None:
                      status = "âœ“ Surplus" if tb > 0 else "âœ— Deficit"
                      print(f"  {currency}: {tb:+15,.2f} M USD/mo  ({status})")
              
              print(f"\n{'='*80}")
              print("EXPECTED VS ACTUAL:")
              print(f"{'='*80}")
              print("  JPY: 106 billion JPY â†’ ~690,000 M USD")
              print("  USD: -56.83 billion USD â†’ -56,830 M USD")
              print("  GBP: -4,340 million GBP â†’ ~-5,920 M USD")
              print("  CHF: +3,036 million CHF â†’ ~+3,944 M USD")
              print(f"{'='*80}")
          
          if __name__ == '__main__':
              print("="*80)
              print("ECONOMIC DATA SCRAPER - SMART SCALE DETECTION")
              print("="*80)
              
              if not fetch_exchange_rates():
                  exit(1)
              
              all_data = scrape_all_indicators()
              validate_and_save(all_data)
              print_summary(all_data)
              
              print("\nâœ… COMPLETED")
          
          EOFPYTHON
          
          python scrape_economics.py
      
      - name: Commit and push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add economic-data/
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "ðŸŽ¯ Smart scale detection for trade balance (country-specific rules) $(date +'%Y-%m-%d')"
            git pull --rebase origin main || true
            git push
          fi
