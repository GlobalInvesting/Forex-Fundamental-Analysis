name: üîç Monitor Data Health

on:
  schedule:
    - cron: '0 11 * * *'   # Todos los d√≠as a las 11:00 UTC ‚Äî despu√©s de que todos los workflows diarios terminan
  workflow_dispatch:

jobs:
  check-data-health:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Check data health
        id: health_check
        run: |
          python3 -u << 'EOFPYTHON'
          import json, os, sys
          from datetime import date, datetime, timedelta

          today     = date.today()
          yesterday = today - timedelta(days=1)
          CURRENCIES = ['USD', 'EUR', 'GBP', 'JPY', 'CAD', 'AUD', 'CHF', 'NZD']

          issues   = []   # (severity, workflow, currency, field, detail)
          warnings = []
          ok_count = 0

          def load_json(path):
              if not os.path.exists(path):
                  return None
              try:
                  with open(path) as f:
                      return json.load(f)
              except Exception as e:
                  return None

          def check_staleness(last_update_str, max_days, label):
              """Returns True if data is fresh enough."""
              if not last_update_str:
                  return False
              try:
                  lu = date.fromisoformat(last_update_str[:10])
                  return (today - lu).days <= max_days
              except:
                  return False

          # ‚îÄ‚îÄ 1. ECONOMIC DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          CRITICAL_INDICATORS = ['inflation', 'gdpGrowth', 'unemployment', 'termsOfTrade']
          IMPORTANT_INDICATORS = ['retailSales', 'wageGrowth', 'manufacturingPMI',
                                  'tradeBalance', 'currentAccount', 'debt']

          for curr in CURRENCIES:
              data = load_json(f'economic-data/{curr}.json')
              if data is None:
                  issues.append(('üî¥', 'Update Economic Data', curr, 'archivo', 'economic-data/{curr}.json no existe'))
                  continue

              if not check_staleness(data.get('lastUpdate'), 2, 'economic'):
                  issues.append(('üü°', 'Update Economic Data', curr, 'lastUpdate',
                                 f"datos tienen m√°s de 2 d√≠as ({data.get('lastUpdate', 'N/A')})"))

              vals = data.get('data', {})
              for ind in CRITICAL_INDICATORS:
                  if vals.get(ind) is None:
                      issues.append(('üî¥', 'Update Economic Data', curr, ind, 'null'))
              for ind in IMPORTANT_INDICATORS:
                  if vals.get(ind) is None:
                      warnings.append(('üü°', 'Update Economic Data', curr, ind, 'null'))

          # ‚îÄ‚îÄ 2. EXTENDED DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          EXTENDED_FIELDS = ['bond10y', 'consumerConfidence', 'rateMomentum']

          for curr in CURRENCIES:
              data = load_json(f'extended-data/{curr}.json')
              if data is None:
                  issues.append(('üî¥', 'Update Extended Data', curr, 'archivo', 'no existe'))
                  continue
              if not check_staleness(data.get('lastUpdate'), 2, 'extended'):
                  issues.append(('üü°', 'Update Extended Data', curr, 'lastUpdate',
                                 f"datos tienen m√°s de 2 d√≠as ({data.get('lastUpdate', 'N/A')})"))
              vals = data.get('data', {})
              for field in EXTENDED_FIELDS:
                  if vals.get(field) is None:
                      warnings.append(('üü°', 'Update Extended Data', curr, field, 'null'))

          # ‚îÄ‚îÄ 3. INTEREST RATES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          for curr in CURRENCIES:
              data = load_json(f'rates/{curr}.json')
              if data is None:
                  issues.append(('üî¥', 'Update Interest Rates', curr, 'archivo', 'no existe'))
                  continue
              if not check_staleness(data.get('lastUpdate'), 2, 'rates'):
                  issues.append(('üü°', 'Update Interest Rates', curr, 'lastUpdate',
                                 f"datos tienen m√°s de 2 d√≠as ({data.get('lastUpdate', 'N/A')})"))
              obs = data.get('observations', [])
              if not obs or obs[0].get('value') is None:
                  issues.append(('üî¥', 'Update Interest Rates', curr, 'rate', 'null'))

          # ‚îÄ‚îÄ 4. FX PERFORMANCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          for curr in CURRENCIES + ['USD']:
              data = load_json(f'fx-performance/{curr}.json')
              if data is None:
                  issues.append(('üî¥', 'Update FX Performance', curr, 'archivo', 'no existe'))
                  continue
              if not check_staleness(data.get('date'), 2, 'fx'):
                  issues.append(('üü°', 'Update FX Performance', curr, 'date',
                                 f"datos tienen m√°s de 2 d√≠as ({data.get('date', 'N/A')})"))
              if curr != 'USD' and data.get('fxPerformance1M') is None:
                  warnings.append(('üü°', 'Update FX Performance', curr, 'fxPerformance1M', 'null'))

          # ‚îÄ‚îÄ 5. COT DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          # COT solo se actualiza los viernes ‚Äî aceptar hasta 8 d√≠as de antig√ºedad
          for curr in ['EUR', 'GBP', 'JPY', 'AUD', 'CAD', 'CHF', 'NZD']:
              data = load_json(f'cot-data/{curr}.json')
              if data is None:
                  warnings.append(('üü°', 'Update COT Data', curr, 'archivo', 'no existe'))
                  continue
              if not check_staleness(data.get('lastUpdate'), 8, 'cot'):
                  warnings.append(('üü°', 'Update COT Data', curr, 'lastUpdate',
                                   f"datos tienen m√°s de 8 d√≠as ({data.get('lastUpdate', 'N/A')})"))

          usd_cot = load_json('cot-data/USD.json')
          if usd_cot is None:
              warnings.append(('üü°', 'Update USD Index COT', 'USD', 'archivo', 'no existe'))
          elif not check_staleness(usd_cot.get('lastUpdate'), 8, 'cot_usd'):
              warnings.append(('üü°', 'Update USD Index COT', 'USD', 'lastUpdate',
                               f"datos tienen m√°s de 8 d√≠as ({usd_cot.get('lastUpdate', 'N/A')})"))

          # ‚îÄ‚îÄ 6. CALENDAR DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          cal = load_json('calendar-data/calendar.json')
          if cal is None:
              issues.append(('üî¥', 'Update Economic Calendar', '‚Äî', 'archivo', 'calendar-data/calendar.json no existe'))
          else:
              if not check_staleness(cal.get('lastUpdate'), 1, 'calendar'):
                  issues.append(('üü°', 'Update Economic Calendar', '‚Äî', 'lastUpdate',
                                 f"datos tienen m√°s de 1 d√≠a ({cal.get('lastUpdate', 'N/A')})"))
              if cal.get('totalEvents', 0) == 0:
                  warnings.append(('üü°', 'Update Economic Calendar', '‚Äî', 'totalEvents', '0 eventos'))

          # ‚îÄ‚îÄ 7. MEETINGS DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          meet = load_json('meetings-data/meetings.json')
          if meet is None:
              warnings.append(('üü°', 'Update Central Bank Meetings', '‚Äî', 'archivo', 'no existe'))
          else:
              for curr in CURRENCIES:
                  info = meet.get('meetings', {}).get(curr, {})
                  if not info.get('nextMeetingISO'):
                      warnings.append(('üü°', 'Update Central Bank Meetings', curr, 'nextMeeting', 'no definida'))

          # ‚îÄ‚îÄ 8. AI ANALYSIS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          ai_missing = []
          for curr in CURRENCIES:
              if not os.path.exists(f'ai-analysis/{curr}.json') and not os.path.exists(f'ai-analysis/{curr.lower()}.json'):
                  ai_missing.append(curr)
          if ai_missing:
              warnings.append(('üü°', 'Generate AI Analysis', ', '.join(ai_missing), 'archivo', 'no existe'))

          # ‚îÄ‚îÄ BUILD SUMMARY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          all_issues = issues + warnings
          critical_count = len(issues)
          warning_count  = len(warnings)

          print(f"\n{'='*60}")
          print(f"DATA HEALTH REPORT ‚Äî {today}")
          print(f"{'='*60}")
          print(f"üî¥ Cr√≠ticos: {critical_count}")
          print(f"üü° Avisos:   {warning_count}")

          if all_issues:
              print(f"\n{'‚îÄ'*60}")
              current_workflow = None
              for severity, workflow, curr, field, detail in all_issues:
                  if workflow != current_workflow:
                      print(f"\n[{workflow}]")
                      current_workflow = workflow
                  print(f"  {severity} {curr} ‚Üí {field}: {detail}")
          else:
              print(f"\n‚úÖ Todo en orden ‚Äî todos los datos est√°n actualizados y completos")

          print(f"\n{'='*60}")

          # Write GitHub Step Summary
          summary_path = os.environ.get('GITHUB_STEP_SUMMARY', '')
          if summary_path:
              with open(summary_path, 'w') as sf:
                  sf.write(f"# üîç Data Health Report ‚Äî {today}\n\n")

                  if critical_count == 0 and warning_count == 0:
                      sf.write("## ‚úÖ Todo en orden\n\nTodos los datos est√°n actualizados y completos.\n")
                  else:
                      if critical_count > 0:
                          sf.write(f"## üî¥ {critical_count} problema(s) cr√≠tico(s)\n\n")
                          sf.write("| Workflow | Moneda | Campo | Detalle |\n")
                          sf.write("|----------|--------|-------|---------|\n")
                          for severity, workflow, curr, field, detail in issues:
                              sf.write(f"| {workflow} | {curr} | `{field}` | {detail} |\n")
                          sf.write("\n")

                      if warning_count > 0:
                          sf.write(f"## üü° {warning_count} aviso(s)\n\n")
                          sf.write("| Workflow | Moneda | Campo | Detalle |\n")
                          sf.write("|----------|--------|-------|---------|\n")
                          for severity, workflow, curr, field, detail in warnings:
                              sf.write(f"| {workflow} | {curr} | `{field}` | {detail} |\n")
                          sf.write("\n")

                  sf.write(f"\n---\n*Generado autom√°ticamente el {datetime.utcnow().strftime('%Y-%m-%d %H:%M UTC')}*\n")

          # Set output for next step
          with open(os.environ.get('GITHUB_OUTPUT', '/dev/null'), 'a') as f:
              f.write(f"critical_count={critical_count}\n")
              f.write(f"warning_count={warning_count}\n")
              # Write issues as compact string for notification
              if all_issues:
                  lines = []
                  for severity, workflow, curr, field, detail in issues[:10]:  # max 10 en el email
                      lines.append(f"{severity} [{curr}] {field}: {detail}")
                  f.write(f"issues_summary={'|'.join(lines)}\n")
              else:
                  f.write("issues_summary=\n")

          # Exit with error if there are critical issues (makes the run appear as failed in GH)
          if critical_count > 0:
              sys.exit(1)
          EOFPYTHON

      - name: Send email notification on failures
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.NOTIFY_EMAIL_FROM }}
          password: ${{ secrets.NOTIFY_EMAIL_PASSWORD }}
          to: ${{ secrets.NOTIFY_EMAIL_TO }}
          from: "FX Dashboard Monitor <${{ secrets.NOTIFY_EMAIL_FROM }}>"
          subject: "üî¥ FX Dashboard ‚Äî Datos faltantes (${{ steps.health_check.outputs.critical_count }} cr√≠ticos)"
          body: |
            El monitor de datos del FX Dashboard detect√≥ problemas el ${{ env.TODAY }}.

            Problemas cr√≠ticos: ${{ steps.health_check.outputs.critical_count }}
            Avisos: ${{ steps.health_check.outputs.warning_count }}

            Detalle:
            ${{ steps.health_check.outputs.issues_summary }}

            Revisar el informe completo en GitHub Actions:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

          # Nota: si no quer√©s configurar email, pod√©s eliminar este step.
          # El Job Summary en GitHub ya muestra todo el detalle visual.
